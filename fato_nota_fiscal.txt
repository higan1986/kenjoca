SELECT nf.nf_key,
       nf.loja_key,
       nf.nf_numero,
       nf.nf_serie,
       pr.produto_key,
       pr.descricao,
       fd.descricao fornecedor_divisao,
       nf.data_emissao,
       nf.data_saida,
       nf.data_entrega_previsao,
       nf.data_recebimento,
       nf.nf_tipo_key,
       nt.descricao nf_tipo_descricao,
       nf.inicio_lancamento,
       nf.fim_lancamento,
       nf.data_recebimento_edi,
       nf.inicio_romaneio,
       nf.movimentacao_carga_key,
       pe1.nome_abreviado conferente,
       pe2.nome_abreviado gerado_por,
       ip.sugestao quantidade_sugestao,
       ip.pendencia_qtd quantidade_pendencia,
       ip.quantidade quantidade_pedido,
       ni.quantidade quantidade_faturada,
       ni.quantidade_recebida,
       ni.quantidade_devolvida,
       ni.valor_bruto ni_valor_bruto,
       ni.valor_bruto_total ni_valor_bruto_total,
       ni.fator_estoque ni_fator_estoque,
       ni.ipi_valor ni_ipi_valor,
       ni.ipi_valor_total ni_ipi_valor_total,
       ni.desconto_final_total ni_desconto_total,
       ni.despesa_tributada ni_despesa_trib,
       ni.despesa_nao_tributada ni_despesa_nao_trib,
       ni.valor_icms ni_valor_icms,
       ni.valor_pis ni_pis_valor,
       ni.valor_pis_total ni_pis_valor_total,
       ni.valor_cofins ni_cofins_valor,
       ni.valor_cofins_total ni_cofins_valor_total,
       ni.icm_fonte_valor_total ni_icm_fonte_valor_total,
       ni.valor_iss ni_valor_iss,
       ni.iva_st ni_iva_st,
       ni.base_calculo_iss ni_base_calculo_iss,
       ni.aliquota_iss ni_aliquota_iss,
       ni.base_calculo_icms ni_base_calculo_icms,
       ni.base_calculo_icms_total ni_base_calculo_icms_total,
       ni.base_calculo_icms_st ni_base_calculo_icms_st,
       ni.base_calculo_icms_st_total ni_base_calculo_icms_st_total,
       ni.base_pis ni_base_pis,
       ni.base_pis_total ni_base_pis_total,
       ni.base_cofins ni_base_cofins,
       ni.base_cofins_total ni_base_cofins_total,
       ni.base_ipi ni_base_ipi,
       ni.base_ipi_total ni_base_ipi_total,
       ni.base_calculo_inss_retido ni_base_calculo_inss_retido,
       ni.custo_contabil_total ni_custo_contabil_total,
       ngi.valor_bruto negociacao_valor_bruto,
       ngi.fator_estoque negociacao_fator_estoque,
       ngi.ipi_valor negociacao_ipi_valor,
       ngi.desconto_total negociacao_desconto_total,
       ngi.despesa_tributada negociacao_despesa_trib,
       ngi.despesa_nao_tributada negociacao_despesa_nao_trib,
       ngi.frete_valor negociacao_frete_valor,
       ngi.pis_valor negociacao_pis_valor,
       ngi.cofins_valor negociacao_cofins_valor,
       ngi.icm_valor negociacao_icm_valor,
       ngi.icm_fonte_valor negociacao_icm_fonte_valor,
       ngi.iva_st negociacao_iva_st,
       ngi.aliquota_interna negociacao_aliquota_interna,
       ngi.base_icmr negociacao_base_icmr,
       ngi.acordo_bonificado_valor negociacao_acordo_bonif,
       ngi.acordo_verba_valor negociacao_acordo_verba,
       ni.ncm,
       pe3.nome_abreviado usuario_cancelamento,
       nf.data_cancelamento,
       nf.justificativa,
       nf.chave,
       nf.protocolo_autorizacao,
       nf.protocolo_cancelamento,
       nf.protocolo_denegacao,
       nf.protocolo_inutilizacao,
       nf.data_processamento_nfe,
       tsn.descricao tipo_status_nfe,
       tdnf.descricao tipo_divergencia_nf,
       tgr.descricao tipo_guia_recolhimento,
       tmnf.descricao tipo_modelo_nf,
       ten.descricao tipo_emissao_nfe,
       NULL protocolo_nfse,
       nf.recebido_por_xml,
       tonf.descricao tipo_operacao_nota_fiscal,
       tmd.descricao tipo_manifestacao_destino,
       tcc.descricao tipo_classe_consumo,
       tle.descricao tipo_ligacao_energia,
       gte.descricao grupo_tensao_energia,
       tac.descricao tipo_assinante_comunicao,
       nf.numero_rps,
       nf.serie_rps,
       tdr.descricao tipo_do_rps,
       tdsne.descricao tipo_de_status_da_nfse,
       tt.descricao tipo_de_tributacao,
       csne.descricao codigo_servico_nfse,
       tsne.descricao tipo_status_nfse,
       nf.tipo_identificacao_operacao,
       ni.pedido_key,
       ip.pelt_key,
       ni.frete_valor ni_frete_valor,
       ni.icm_fonte_valor ni_icm_fonte_valor,
       ni.valor_pauta_fiscal ni_valor_pauta_fiscal,
       ni.seguro ni_seguro,
       ni.funrural ni_funrural,
       ni.frete_valor_total ni_frete_valor_total,
       ni.valor_pauta_fiscal_total ni_valor_pauta_fiscal_total,
       ni.seguro_total ni_seguro_total,
       ni.funrural_total ni_funrural_total,
       ni.valor_icms_total ni_valor_icms_total,
       ni.despesa_tributada_total ni_despesa_trib_total,
       ni.despesa_nao_tributada_total ni_despesa_nao_trib_total,
       ngi.negociacao_item_key
FROM nota_fiscal nf
JOIN nota_fiscal_item ni ON nf.nf_key = ni.nf_key
JOIN produto pr ON ni.controle_estoque = pr.produto_key
JOIN nota_fiscal_tipo nt ON nf.nf_tipo_key = nt.nf_tipo_key
JOIN fornecedor_divisao fd ON ni.fornecedor_divisao_key = fd.fornecedor_divisao_key
LEFT JOIN nota_fiscal_pedido nfp ON nf.nf_key = nfp.nf_key
LEFT JOIN item_pedido ip ON nfp.pelt_key = ip.pelt_key
AND ni.controle_estoque = ip.produto_venda_key
LEFT JOIN negociacao_item ngi ON ip.negociacao_item_key = ngi.negociacao_item_key
LEFT JOIN movimentacao_carga mc ON nf.movimentacao_carga_key = mc.movimentacao_carga_key
LEFT JOIN pessoa pe1 ON mc.conferente = pe1.pessoa_key
LEFT JOIN pessoa pe2 ON mc.gerado_por = pe2.pessoa_key
LEFT JOIN pessoa pe3 ON nf.usuario_cancelamento_key = pe3.pessoa_key
LEFT JOIN tipo_status_nfe tsn ON nf.tipo_status_nfe_key = tsn.tipo_status_nfe_key
LEFT JOIN tipo_divergencia_nota_fiscal tdnf ON nf.tipo_divergencia_nf_key = tdnf.tipo_divergencia_nf_key
LEFT JOIN tipo_guia_recolhimento tgr ON nf.tipo_guia_recolhimento_key = tgr.tipo_guia_recolhimento_key
LEFT JOIN tipo_modelo_nf tmnf ON nf.tipo_modelo_nf_key = tmnf.tipo_modelo_nf_key
LEFT JOIN tipo_emissao_nfe ten ON nf.tipo_emissao_nfe_key = ten.tipo_emissao_nfe_key
LEFT JOIN tipo_operacao_nota_fiscal tonf ON nf.tipo_operacao_nota_fiscal_key = tonf.tipo_operacao_nota_fiscal_key
LEFT JOIN tipo_manifestacao_destinatario tmd ON nf.tipo_manifestacao_dest_key = tmd.tipo_manifestacao_dest_key
LEFT JOIN local_de_estoque lde ON nf.local_de_estoque_key = lde.local_de_estoque_key
LEFT JOIN tipo_classe_consumo tcc ON nf.tipo_classe_consumo_key = tcc.tipo_classe_consumo_key
LEFT JOIN tipo_ligacao_energia tle ON nf.tipo_ligacao_energia_key = tle.tipo_ligacao_energia_key
LEFT JOIN grupo_tensao_energia gte ON nf.grupo_tensao_energia_key = gte.grupo_tensao_energia_key
LEFT JOIN tipo_assinante_comunicacao tac ON nf.tipo_assinante_comunicacao_key = tac.tipo_assinante_comunicacao_key
LEFT JOIN tipo_do_rps tdr ON nf.tipo_do_rps_key = tdr.tipo_do_rps_key
LEFT JOIN tipo_de_status_da_nfse tdsne ON nf.tipo_de_status_da_nfse_key = tdsne.tipo_de_status_da_nfse_key
LEFT JOIN tipo_de_tributacao tt ON nf.tipo_de_tributacao_key = tt.tipo_de_tributacao_key
LEFT JOIN codigo_servico_nfse csne ON nf.codigo_servico_nfse_key = csne.codigo_servico_nfse_key
LEFT JOIN tipo_status_nfse tsne ON nf.tipo_status_nfse_key = tsne.tipo_status_nfse_key
WHERE trunc(nf.data_recebimento) BETWEEN CURRENT_DATE - 30 AND CURRENT_DATE
  AND ni.produto_key = ngi.produto_key
ORDER BY pr.descricao